name: GitSecretsScan

on: workflow_dispatch

jobs:
  git-secret-check:
    name: Git Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          path: src/github.com/aws/amazon-ecs-agent
      - name: Git Secrets Scan Script
        run: |
          set -ex
          cd $GITHUB_WORKSPACE
          git clone https://github.com/awslabs/git-secrets.git && cd git-secrets
          sudo make install
          git secrets --register-aws --global
          cd $GITHUB_WORKSPACE/src/github.com/aws/amazon-ecs-agent
          git secrets --install
          git secrets --register-aws
          git secrets --scan-history
      - name: Make and commit changes
        run: |
          set -ex
          sed -i '1ihello world' CHANGELOG.md
          git status
          git add -A
          git -c user.name="github-actions[bot]" \
            -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
            commit -m "test"
          git push --set-upstream origin ${{ github.ref_name }}
      - name: Open PR
        env:
          GH_TOKEN: ${{ secrets.ECS_AGENT_WORKFLOW_SECRET }}
        run: |
          set -ex
          gh pr create \
            --title "test" \
            --body "test" \
            --base dev \
            --head ${{ github.ref_name }}
