//go:build windows
// +build windows

// Copyright Amazon.com Inc. or its affiliates. All Rights Reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License"). You may
// not use this file except in compliance with the License. A copy of the
// License is located at
//
//      http://aws.amazon.com/apache2.0/
//
// or in the "license" file accompanying this file. This file is distributed
// on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
// express or implied. See the License for the specific language governing
// permissions and limitations under the License.

package manageddaemon

import (
	"fmt"
	"os"
	"path/filepath"
)

const (

	// This is the path to where the CSIDriver ManagedDaemon image tar file is
	imageTarPath = "C:\\ProgramData\\Amazon\\ECS\\data\\"
	// This is the image tag that will be used for the ManagedDaemon image
	imageTagDefault = "latest"
	// The following two paths are used for agent communication and log paths to be shared with the ManagedDaemon
	defaultAgentCommunicationPathHostRoot = "C:\\ProgramData\\Amazon\\ECS"
	defaultApplicationLogPathHostRoot     = "C:\\ProgramData\\Amazon\\ECS\\log"
	// These two constants store the names of the different mounts that will be used for the Windows ManagedDaemon
	defaultAgentCommunicationMount = "agentCommunicationMount"
	defaultApplicationLogMount     = "applicationLogMount"

	// The following two host and container paths are for the agent communication with the CSIDriver ManagedDaemon
	agentCommunicationMountHostPath      = "C:\\ProgramData\\Amazon\\ECS\\ebs-csi-driver"
	agentCommunicationMountContainerPath = "C:\\ebs-csi-driver\\"

	// The following two host and container paths are for the log storage for the CSIDriverManaged Daemon
	csiDriverLogMountHostPath      = "C:\\ProgramData\\Amazon\\ECS\\log\\daemons"
	csiDriverLogMountContainerPath = "C:\\csi-driver\\log"

	// The following two host and container paths are for the shared mount for the CSIDriverManaged Daemon.
	sharedMountsHostPath      = "C:\\ProgramData\\Amazon\\ECS\\ebs"
	sharedMountsContainerPath = "C:\\csi-driver\\ebs\\"
	// The following two host and container paths are for communicating with the CSIProxy disk named pipe for the CSIDriverManaged Daemon
	csiProxyDiskMountHostPath      = "\\\\.\\pipe\\csi-proxy-disk-v1"
	csiProxyDiskMountContainerPath = "\\\\.\\pipe\\csi-proxy-disk-v1"
	// The following two host and container paths are for communicating with the CSIProxy filesystem named pipe for the CSIDriverManaged Daemon
	csiProxyFileSystemMountHostPath      = "\\\\.\\pipe\\csi-proxy-filesystem-v1"
	csiProxyFileSystemMountContainerPath = "\\\\.\\pipe\\csi-proxy-filesystem-v1"
	// The following two host and container paths are for communicating with the CSIProxy disk named pipe for the CSIDriverManaged Daemon
	csiProxyVolumeMountHostPath      = "\\\\.\\pipe\\csi-proxy-volume-v1"
	csiProxyVolumeMountContainerPath = "\\\\.\\pipe\\csi-proxy-volume-v1"
	// This is the path to the CSIDriver listener socket. The agent communicates with the CSIDriver ManagedDaemon on this path
	csiDriverListenerSocketPath = "unix://ebs-csi-driver/csi-driver.sock"
	// This is the path to the log file that is generated by the CSIDriver ManagedDaemon
	csiDriverLogFilePath = "C:\\csi-driver\\log\\csi.log"
)

// defaultImportAll function will parse/validate all managed daemon definitions
// defined and will return an array of valid ManagedDaemon objects
func defaultImportAll() ([]*ManagedDaemon, error) {
	ebsCsiTarFile := filepath.Join(imageTarPath, EbsCsiDriver, imageFileName)
	if _, err := os.Stat(ebsCsiTarFile); err != nil {
		return []*ManagedDaemon{}, nil
	}
	// locate the EBS CSI tar file -- import
	ebsManagedDaemon := NewManagedDaemon(EbsCsiDriver, "latest")
	// add required mounts
	ebsMounts := []*MountPoint{
		&MountPoint{
			SourceVolumeID:       defaultAgentCommunicationMount,
			SourceVolume:         defaultAgentCommunicationMount,
			SourceVolumeType:     "host",
			SourceVolumeHostPath: agentCommunicationMountHostPath,
			ContainerPath:        agentCommunicationMountContainerPath,
		},
		&MountPoint{
			SourceVolumeID:       defaultApplicationLogMount,
			SourceVolume:         defaultApplicationLogMount,
			SourceVolumeType:     "host",
			SourceVolumeHostPath: csiDriverLogMountHostPath,
			ContainerPath:        csiDriverLogMountContainerPath,
		},
		&MountPoint{
			SourceVolumeID:       "sharedMounts",
			SourceVolume:         "sharedMounts",
			SourceVolumeType:     "host",
			SourceVolumeHostPath: sharedMountsHostPath,
			ContainerPath:        sharedMountsContainerPath,
			PropagationShared:    false,
		},
		// the following three mount points are for connecting to the CSIProxy server that is running
		// as a Windows Service on the host
		&MountPoint{
			SourceVolumeID:       "csiProxyDiskMount",
			SourceVolume:         "csiProxyDiskMount",
			SourceVolumeType:     "npipe",
			SourceVolumeHostPath: csiProxyDiskMountHostPath,
			ContainerPath:        csiProxyDiskMountContainerPath,
			PropagationShared:    false,
		},
		&MountPoint{
			SourceVolumeID:       "csiProxyFileSystemMount",
			SourceVolume:         "csiProxyFileSystemMount",
			SourceVolumeType:     "npipe",
			SourceVolumeHostPath: csiProxyFileSystemMountHostPath,
			ContainerPath:        csiProxyFileSystemMountContainerPath,
			PropagationShared:    false,
		},
		&MountPoint{
			SourceVolumeID:       "csiProxyVolumeMount",
			SourceVolume:         "csiProxyVolumeMount",
			SourceVolumeType:     "npipe",
			SourceVolumeHostPath: csiProxyVolumeMountHostPath,
			ContainerPath:        csiProxyVolumeMountContainerPath,
			PropagationShared:    false,
		},
	}
	if err := ebsManagedDaemon.SetMountPoints(ebsMounts); err != nil {
		return nil, fmt.Errorf("Unable to import EBS ManagedDaemon: %s", err)
	}
	var thisCommand []string
	thisCommand = append(thisCommand, fmt.Sprintf("-endpoint=%s", csiDriverListenerSocketPath))
	thisCommand = append(thisCommand, fmt.Sprintf("-log_file=%s", csiDriverLogFilePath))
	thisCommand = append(thisCommand, "-log_file_max_size=20")
	thisCommand = append(thisCommand, "-logtostderr=false")

	ebsManagedDaemon.command = thisCommand
	ebsManagedDaemon.privileged = false
	return []*ManagedDaemon{ebsManagedDaemon}, nil
}
